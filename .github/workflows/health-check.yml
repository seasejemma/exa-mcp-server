name: Post-Deploy Health Check

# ============================================================================
# WORKFLOW: Verify Deno Deploy deployment is healthy
# ============================================================================
# Triggers:
#   - After push to main (Deno Deploy auto-deploys)
#   - Manual dispatch for testing
#   - Called by other workflows
# ============================================================================

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_url:
        description: 'Custom deploy URL to test (optional)'
        type: string
        required: false
  workflow_call:
    inputs:
      deploy_url:
        description: 'Deploy URL to test'
        type: string
        required: false
    secrets:
      MCP_AUTH_TOKEN:
        required: true

jobs:
  health-check:
    name: Health Check & MCP Tests
    runs-on: ubuntu-latest
    env:
      DEPLOY_URL: ${{ inputs.deploy_url || vars.MCP_SERVER_ENDPOINT || 'https://exa-mcp.seasejemma.deno.net' }}
    outputs:
      health_status: ${{ steps.health.outputs.status }}
      mcp_status: ${{ steps.mcp.outputs.status }}

    steps:
      - name: Wait for Deno Deploy
        run: |
          echo "‚è≥ Waiting 90 seconds for Deno Deploy to complete..."
          echo "Target: $DEPLOY_URL"
          sleep 90

      - name: Check /health endpoint
        id: health
        run: |
          echo "üîç Testing health endpoint at $DEPLOY_URL..."
          
          # Retry logic for cold starts
          for i in 1 2 3; do
            RESPONSE=$(curl -s -w "\n%{http_code}" "$DEPLOY_URL/health" --max-time 30)
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "Attempt $i - HTTP: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "‚úÖ Health check passed"
              echo "$BODY" | jq . 2>/dev/null || echo "$BODY"
              exit 0
            fi
            
            [ $i -lt 3 ] && sleep 10
          done
          
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "‚ùå Health check failed after 3 attempts"
          exit 1

      - name: Test MCP Initialize
        id: mcp
        env:
          MCP_AUTH_TOKEN: ${{ secrets.MCP_AUTH_TOKEN }}
        run: |
          echo "üîç Testing MCP initialize..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_URL/mcp" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json, text/event-stream" \
            -H "Authorization: Bearer $MCP_AUTH_TOKEN" \
            --max-time 30 \
            -d '{
              "jsonrpc": "2.0",
              "method": "initialize",
              "params": {
                "protocolVersion": "2024-11-05",
                "capabilities": {},
                "clientInfo": {"name": "github-actions", "version": "1.0"}
              },
              "id": 1
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå MCP initialize failed with HTTP $HTTP_CODE"
            exit 1
          fi
          
          if echo "$BODY" | jq -e '.error' > /dev/null 2>&1; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå MCP initialize returned error"
            exit 1
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ MCP initialize passed"

      - name: Test tools/list
        env:
          MCP_AUTH_TOKEN: ${{ secrets.MCP_AUTH_TOKEN }}
        run: |
          echo "üîç Testing tools/list..."
          
          # First, we need to initialize a new session and get the session ID from headers
          INIT_RESPONSE=$(curl -s -i -X POST "$DEPLOY_URL/mcp" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json, text/event-stream" \
            -H "Authorization: Bearer $MCP_AUTH_TOKEN" \
            -d '{
              "jsonrpc": "2.0",
              "method": "initialize",
              "params": {
                "protocolVersion": "2024-11-05",
                "capabilities": {},
                "clientInfo": {"name": "github-actions", "version": "1.0"}
              },
              "id": 1
            }')
          
          # Extract session ID from headers (case-insensitive)
          SESSION_ID=$(echo "$INIT_RESPONSE" | grep -i "mcp-session-id:" | cut -d' ' -f2 | tr -d '\r')
          echo "Session ID: $SESSION_ID"
          
          if [ -z "$SESSION_ID" ]; then
            echo "‚ö†Ô∏è Could not extract session ID, skipping tools/list test"
            exit 0
          fi
          
          # Now call tools/list with the session ID
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_URL/mcp" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json, text/event-stream" \
            -H "Authorization: Bearer $MCP_AUTH_TOKEN" \
            -H "Mcp-Session-Id: $SESSION_ID" \
            -d '{
              "jsonrpc": "2.0",
              "method": "tools/list",
              "params": {},
              "id": 2
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå tools/list failed with HTTP $HTTP_CODE"
            exit 1
          fi
          
          # Check that we got tools in the response
          TOOL_COUNT=$(echo "$BODY" | jq -r '.result.tools | length // 0')
          echo "Found $TOOL_COUNT tools"
          
          if [ "$TOOL_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No tools returned (may be expected based on config)"
          else
            echo "Tools available:"
            echo "$BODY" | jq -r '.result.tools[].name' 2>/dev/null || true
          fi
          
          echo "‚úÖ tools/list passed"

      - name: Test web_search_exa tool
        env:
          MCP_AUTH_TOKEN: ${{ secrets.MCP_AUTH_TOKEN }}
        run: |
          echo "Testing web_search_exa tool..."
          
          # Initialize session
          INIT_RESPONSE=$(curl -s -i -X POST "$DEPLOY_URL/mcp" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json, text/event-stream" \
            -H "Authorization: Bearer $MCP_AUTH_TOKEN" \
            -d '{
              "jsonrpc": "2.0",
              "method": "initialize",
              "params": {
                "protocolVersion": "2024-11-05",
                "capabilities": {},
                "clientInfo": {"name": "github-actions", "version": "1.0"}
              },
              "id": 1
            }')
          
          SESSION_ID=$(echo "$INIT_RESPONSE" | grep -i "mcp-session-id:" | cut -d' ' -f2 | tr -d '\r')
          
          if [ -z "$SESSION_ID" ]; then
            echo "‚ö†Ô∏è Could not extract session ID, skipping tool call test"
            exit 0
          fi
          
          # Call web_search_exa with a simple query
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_URL/mcp" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json, text/event-stream" \
            -H "Authorization: Bearer $MCP_AUTH_TOKEN" \
            -H "Mcp-Session-Id: $SESSION_ID" \
            -d '{
              "jsonrpc": "2.0",
              "method": "tools/call",
              "params": {
                "name": "web_search_exa",
                "arguments": {
                  "query": "github actions health check",
                  "numResults": 1
                }
              },
              "id": 3
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå web_search_exa failed with HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
          
          # Check for error in response
          if echo "$BODY" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$BODY" | jq -r '.error.message')
            echo "‚ùå web_search_exa returned error: $ERROR_MSG"
            exit 1
          fi
          
          # Check that we got content
          CONTENT_LENGTH=$(echo "$BODY" | jq -r '.result.content | length // 0')
          echo "Got $CONTENT_LENGTH content items"
          
          if [ "$CONTENT_LENGTH" -gt 0 ]; then
            echo "‚úÖ web_search_exa returned results"
          else
            echo "‚ö†Ô∏è web_search_exa returned no content (may be rate limited)"
          fi
          
          echo "‚úÖ web_search_exa test completed"

      - name: Test /mcp/usage endpoint
        env:
          MCP_AUTH_TOKEN: ${{ secrets.MCP_AUTH_TOKEN }}
        run: |
          echo "Testing /mcp/usage endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DEPLOY_URL/mcp/usage" \
            -H "Authorization: Bearer $MCP_AUTH_TOKEN")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå /mcp/usage failed with HTTP $HTTP_CODE"
            exit 1
          fi
          
          # Check for usageCount in response
          if echo "$BODY" | jq -e '.usageCount' > /dev/null 2>&1; then
            USAGE=$(echo "$BODY" | jq -r '.usageCount')
            echo "Usage count: $USAGE"
            echo "‚úÖ /mcp/usage passed"
          else
            echo "‚ö†Ô∏è usageCount not found in response"
          fi

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "  Post-Deploy Health Check Summary"
          echo "=========================================="
          echo "Deploy URL: $DEPLOY_URL"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="
